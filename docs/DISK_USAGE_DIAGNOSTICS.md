# Disk Usage Diagnostics API

Comprehensive disk space monitoring and debugging for capture directories.

## API Endpoints

### Server Proxy Endpoint (Recommended)
```
GET /server/system/diskUsage?host_name=<host>&capture_dir=<capture>
```

### Direct Host Endpoint
```
GET /host/monitoring/disk-usage?capture_dir=<capture>
```

## Parameters

| Parameter | Required | Default | Description |
|-----------|----------|---------|-------------|
| `host_name` | Yes (server) | - | Which host to query (e.g., "raspberrypi") |
| `capture_dir` | No | `all` | Specific capture to analyze (e.g., "capture1") or "all" |

## Usage Examples

### Check all captures on a host
```bash
curl "http://localhost:6110/server/system/diskUsage?host_name=raspberrypi"
```

### Check specific capture
```bash
curl "http://localhost:6110/server/system/diskUsage?host_name=raspberrypi&capture_dir=capture1"
```

### Direct host query (if on the host machine)
```bash
curl "http://localhost:6109/host/monitoring/disk-usage?capture_dir=all"
```

## Response Format

```json
{
  "success": true,
  "host_name": "raspberrypi",
  "system_disk": {
    "filesystem": "/dev/mmcblk0p2",
    "size": "115G",
    "used": "108G",
    "available": "2.1G",
    "use_percent": "99%",
    "mounted_on": "/var/www/html/stream"
  },
  "summary": {
    "captures_analyzed": 4,
    "total_segments": 234560,
    "total_captures": 432000,
    "total_thumbnails": 432000,
    "cleanup_healthy": false,
    "temp_files_healthy": true
  },
  "captures": [
    {
      "capture_name": "capture1",
      "path": "/var/www/html/stream/capture1",
      "total_size": "24G",
      "segments": {
        "count": 86400,
        "size_gb": 4.6,
        "avg_size_kb": 54.3
      },
      "captures": {
        "count": 432000,
        "size_gb": 15.1,
        "avg_size_kb": 35.2
      },
      "thumbnails": {
        "count": 432000,
        "size_gb": 5.2,
        "avg_size_kb": 12.1
      },
      "json_files": {
        "count": 125,
        "size_mb": 15.3
      },
      "transcripts": {
        "count": 24,
        "size_mb": 2.5
      },
      "cleanup_health": {
        "old_segments_24h": 0,
        "old_captures_24h": 0,
        "is_healthy": true,
        "warning": null
      }
    }
  ],
  "cleanup_status": {
    "log_exists": true,
    "last_run": "Mon Jan  6 14:30:00 UTC 2025: Starting cleanup run",
    "log_lines": 45,
    "active_processes": 4
  },
  "config_status": {
    "exists": true,
    "configured_captures": [
      "/var/www/html/stream/capture1",
      "/var/www/html/stream/capture2",
      "/var/www/html/stream/capture3",
      "/var/www/html/stream/capture4"
    ],
    "count": 4
  },
  "temp_files_status": {
    "leaked_temp_dirs": 0,
    "old_audio_files": 0,
    "old_merged_ts": 0,
    "is_healthy": true,
    "warning": null
  },
  "warnings": []
}
```

## Key Metrics Explained

### System Disk
- Overall disk usage for the storage device
- **Alert if `use_percent` > 95%**

### Cleanup Health
- `old_segments_24h`: Files older than 24h (should be 0)
- `old_captures_24h`: Captures older than 24h (should be 0)
- `is_healthy`: `true` if no old files exist
- **If unhealthy: cleanup is not running or broken**

### Temp Files Status
- `leaked_temp_dirs`: Temporary directories not cleaned up
- `old_audio_files`: Audio temp files > 1h old
- `old_merged_ts`: Merged TS files > 1h old
- **If unhealthy: transcription service leaking temp files**

### Config Status
- `exists`: Whether `/tmp/active_captures.conf` exists
- **If false: FFmpeg script not running or cleanup using fallback**

## Troubleshooting

### High Disk Usage (> 95%)
1. Check `cleanup_health` for each capture
2. If unhealthy: Files not being deleted after 24h
3. Check `cleanup_status.active_processes` (should be 4 for 4 captures)
4. Check `config_status.exists` (should be true)

### Files Older Than 24h
```json
"cleanup_health": {
  "old_segments_24h": 15000,
  "old_captures_24h": 72000,
  "is_healthy": false,
  "warning": "Files older than 24h found - cleanup may not be working"
}
```

**Solution:**
1. Check if cleanup processes are running: `ps aux | grep clean_captures`
2. Manually run cleanup: `sudo /path/to/clean_captures.sh`
3. Check cleanup logs: `cat /tmp/clean.log`

### Temp File Accumulation
```json
"temp_files_status": {
  "leaked_temp_dirs": 1250,
  "old_audio_files": 350,
  "old_merged_ts": 120,
  "is_healthy": false,
  "warning": "Temp file accumulation detected"
}
```

**Solution:**
1. Restart transcription service
2. Clean up manually:
   ```bash
   find /tmp -name 'audio_extract_*' -type d -exec rm -rf {} +
   rm -f /tmp/audio_*.wav /tmp/merged_ts_*.ts
   ```

### Missing Config File
```json
"config_status": {
  "exists": false,
  "warning": "Config file missing - cleanup using fallback/auto-discovery"
}
```

**Solution:**
- FFmpeg capture script not running or crashed
- Check FFmpeg service: `sudo systemctl status stream`
- Config file is auto-generated by `run_ffmpeg_and_rename_local.sh`

## Expected 24h Capacity

### Per Hardware Device (with audio)
- Segments: ~4.6 GB
- Full-res captures (5 FPS): ~15 GB
- Thumbnails (5 FPS): ~5 GB
- JSON + Transcripts: ~0.5 GB
- **Total: ~25 GB per device**

### Host VNC Device (no audio)
- Segments: ~3.2 GB
- Captures (2 FPS): ~3.5 GB
- Thumbnails (2 FPS): ~1.4 GB
- **Total: ~8 GB**

### System Total (4 devices)
**~83 GB for 24h retention**

## Integration with Frontend

### React Hook Example
```typescript
import { useState } from 'react';

export function useDiskUsage(hostName: string) {
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState(null);
  const [error, setError] = useState(null);

  const fetchDiskUsage = async (captureDir = 'all') => {
    setLoading(true);
    try {
      const response = await fetch(
        `/server/system/diskUsage?host_name=${hostName}&capture_dir=${captureDir}`
      );
      const result = await response.json();
      
      if (result.success) {
        setData(result);
        setError(null);
      } else {
        setError(result.error);
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return { data, loading, error, fetchDiskUsage };
}
```

### Usage in Component
```typescript
function DiskMonitor({ hostName }) {
  const { data, loading, error, fetchDiskUsage } = useDiskUsage(hostName);

  useEffect(() => {
    fetchDiskUsage(); // Fetch on mount
    const interval = setInterval(() => fetchDiskUsage(), 300000); // Every 5 min
    return () => clearInterval(interval);
  }, [hostName]);

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error}</div>;
  if (!data) return null;

  const isHealthy = data.summary.cleanup_healthy && data.summary.temp_files_healthy;
  const diskUsagePercent = parseInt(data.system_disk.use_percent);

  return (
    <div>
      <h2>Disk Usage: {data.system_disk.use_percent}</h2>
      {diskUsagePercent > 95 && (
        <Alert severity="error">Disk space critical!</Alert>
      )}
      {!isHealthy && (
        <Alert severity="warning">
          Cleanup issues detected. Check warnings.
        </Alert>
      )}
      {data.warnings.length > 0 && (
        <ul>
          {data.warnings.map(w => w && <li key={w}>{w}</li>)}
        </ul>
      )}
    </div>
  );
}
```

## Command Line Usage

### Quick Health Check
```bash
curl -s "http://localhost:6110/server/system/diskUsage?host_name=raspberrypi" | jq '{
  disk: .system_disk.use_percent,
  cleanup_healthy: .summary.cleanup_healthy,
  temp_files_healthy: .summary.temp_files_healthy,
  warnings: .warnings
}'
```

### Check Specific Capture Breakdown
```bash
curl -s "http://localhost:6110/server/system/diskUsage?host_name=raspberrypi&capture_dir=capture1" | jq '.captures[0] | {
  name: .capture_name,
  total: .total_size,
  segments_gb: .segments.size_gb,
  captures_gb: .captures.size_gb,
  thumbnails_gb: .thumbnails.size_gb,
  old_files: .cleanup_health
}'
```

