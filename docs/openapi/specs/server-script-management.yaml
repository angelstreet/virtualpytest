openapi: 3.0.0
info:
  title: SERVER - Script Management
  version: 1.0.0
  description: Script management and execution
servers:
  - url: '{{server_url}}'
paths:
  /server/script/list:
    get:
      summary: List Scripts
      description: Get a list of all available Python scripts in the test_scripts directory
      tags: [Scripts]
      parameters:
        - name: team_id
          in: query
          required: true
          schema:
            type: string
          description: Team identifier for access control
          example: "{{team_id}}"
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
          description: Bearer token for authentication
          example: Bearer {{api_key}}
      responses:
        '200':
          description: List of available scripts
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  scripts:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        path:
                          type: string
        '400':
          description: Bad request - team_id is required
        '500':
          description: Internal error retrieving scripts
  /server/script/analyze:
    post:
      summary: Analyze Script
      description: Analyze a Python script to extract parameter information from argparse definitions
      tags: [Scripts]
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
          description: Bearer token for authentication
          example: Bearer {{api_key}}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - script_name
              properties:
                script_name:
                  type: string
                  description: Name of the script file to analyze
                  example: "{{script_name}}"
                device_model:
                  type: string
                  description: Device model (optional)
                  example: "{{device_model}}"
                device_id:
                  type: string
                  description: Device identifier (optional)
                  example: "{{device_id}}"
      responses:
        '200':
          description: Analysis result with script parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  parameters:
                    type: array
                    items:
                      type: object
        '400':
          description: Bad request - script_name is required
        '404':
          description: Script not found
  /server/script/get_edge_options:
    post:
      summary: Get Edge Options
      description: Get available edge action_set labels for KPI measurement scripts
      tags: [Scripts]
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
          description: Bearer token for authentication
          example: Bearer {{api_key}}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userinterface_name
                - team_id
                - host_name
              properties:
                userinterface_name:
                  type: string
                  description: User interface name (e.g., 'horizon_android_mobile', 'horizon_tv')
                  example: "{{userinterface_name}}"
                team_id:
                  type: string
                  description: Team identifier
                  example: "{{team_id}}"
                host_name:
                  type: string
                  description: Name of the host where device is located
                  example: "{{host_name}}"
      responses:
        '200':
          description: List of edge options
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  edges:
                    type: array
                    items:
                      type: object
        '400':
          description: Bad request - missing required parameters
        '404':
          description: Host not found
  /server/script/execute:
    post:
      summary: Execute Script
      description: Execute a Python script asynchronously on a specified host/device. Returns a task_id for polling script status.
      tags: [Scripts]
      parameters:
        - name: team_id
          in: query
          required: false
          schema:
            type: string
          description: Team identifier (optional)
          example: "{{team_id}}"
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
          description: Bearer token for authentication
          example: Bearer {{api_key}}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - host_name
                - device_id
                - script_name
              properties:
                host_name:
                  type: string
                  description: Name of the host where device is located
                  example: "{{host_name}}"
                device_id:
                  type: string
                  description: Device identifier (e.g., 'device1')
                  example: "{{device_id}}"
                script_name:
                  type: string
                  description: Script filename (e.g., 'validation.py')
                  example: "{{script_name}}"
                parameters:
                  type: string
                  description: Optional CLI parameters as string (e.g., '--param1 value1 --param2 value2')
                  example: "{{script_parameters}}"
      responses:
        '202':
          description: Script execution started asynchronously
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  task_id:
                    type: string
                    description: Task ID for polling execution status
                  message:
                    type: string
        '400':
          description: Bad request - missing required parameters
        '404':
          description: Host not found
        '423':
          description: Device is locked by another session
        '500':
          description: Failed to lock device or internal error
  /server/script/status/{task_id}:
    get:
      summary: Get Script Execution Status
      description: Poll for script execution status using the task_id returned from /script/execute
      tags: [Scripts]
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
          description: Task ID returned from /script/execute endpoint
          example: "{{task_id}}"
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
          description: Bearer token for authentication
          example: Bearer {{api_key}}
      responses:
        '200':
          description: Task status information
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  task:
                    type: object
                    properties:
                      status:
                        type: string
                        enum: [pending, running, completed, failed]
                      result:
                        type: object
                        description: Execution result (available when completed)
                      error:
                        type: string
                        description: Error message (available when failed)
                      created_at:
                        type: number
                        description: Task creation timestamp
                      completed_at:
                        type: number
                        description: Task completion timestamp
        '404':
          description: Task not found
        '500':
          description: Internal error retrieving task status
  /server/script/taskComplete:
    post:
      summary: Task Complete Callback
      description: Webhook endpoint to receive script execution completion callbacks from hosts
      tags: [Scripts]
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
          description: Bearer token for authentication
          example: Bearer {{api_key}}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - task_id
              properties:
                task_id:
                  type: string
                  description: Task ID returned from /script/execute
                  example: "{{task_id}}"
                result:
                  type: object
                  description: Execution result data (optional)
                  properties:
                    report_url:
                      type: string
                      description: URL to execution report
                    success:
                      type: boolean
                error:
                  type: string
                  description: Error message if execution failed (optional)
                  example: "Script execution failed: timeout"
      responses:
        '200':
          description: Callback processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          description: Bad request - task_id is required
        '500':
          description: Internal error processing callback
