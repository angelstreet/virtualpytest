<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Mobile Scaling Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Modal Container - Exact RecHostStreamModal replication */
        .modal-container {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        .modal-content {
            width: 95vw;
            height: 90vh;
            background-color: #1e1e1e;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 8px 16px;
            background-color: #2d2d2d;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 48px;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            background-color: black;
            position: relative;
        }
        
        .test-section {
            margin-bottom: 20px;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
        }
        
        /* Stream Container - Exact RecHostStreamModal replication */
        .stream-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: black;
        }
        
        .stream-container.with-remote {
            width: 75%;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border: 2px solid #444;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        /* Test 1: Current problematic mobile scaling */
        .mobile-scaling {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .mobile-scaling video {
            width: auto;
            height: 100%;
            object-fit: contain;
        }
        
        /* Test 2: Fixed mobile scaling */
        .fixed-mobile-scaling {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .fixed-mobile-scaling video {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }
        
        /* Test 3: Aspect ratio container */
        .aspect-ratio-container {
            aspect-ratio: 9/16;
            max-height: 400px;
            max-width: 225px;
            margin: 0 auto;
        }
        
        .aspect-ratio-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Test 4: Responsive container */
        .responsive-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .responsive-container video {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        
        /* Test 5: RecHostStreamModal exact replication */
        .modal-replication {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: black;
        }
        
        .modal-replication video {
            width: 100%;
            height: 100%;
            object-fit: fill; /* Mobile: fill, Desktop: contain */
            aspect-ratio: 9/16; /* Mobile portrait */
        }
        
        .info {
            background: #222;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .controls {
            margin: 10px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .error {
            color: #ff6b6b;
            background: #2d1b1b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success {
            color: #51cf66;
            background: #1b2d1b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .dimensions {
            font-family: monospace;
            font-size: 12px;
            background: #111;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Modal Replica Test - Exact RecHostStreamModal Structure -->
    <div class="modal-container" id="modalTest" style="display: none;">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header">
                <div style="font-size: 18px; font-weight: 600;">S21x - Live Stream (Modal Test)</div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn" onclick="toggleModalRemote()">Show Remote</button>
                    <button class="btn" onclick="closeModal()">âœ• Close</button>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="modal-main-content">
                <!-- Stream Container -->
                <div class="stream-container" id="modalStreamContainer">
                    <video id="modalVideo" 
                           style="width: 100%; height: 100%; object-fit: fill; aspect-ratio: 9/16; background: black;"
                           muted playsinline autoplay preload="none"></video>
                </div>
                
                <!-- Remote Panel (hidden by default) -->
                <div id="modalRemotePanel" style="display: none; width: 25%; background: #2d2d2d; border-left: 1px solid #555; padding: 16px;">
                    <h3>Remote Panel</h3>
                    <p>This simulates the remote control panel</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>HLS Mobile Scaling Test</h1>
        <p>Testing HLS stream: <code>https://dev.virtualpytest.com/host/stream/capture1/output.m3u8</code></p>                                                                                                         
        
        <div class="controls">
            <button onclick="loadAllStreams()">Load All Streams</button>
            <button onclick="stopAllStreams()">Stop All Streams</button>
            <button onclick="toggleMute()">Toggle Mute</button>
            <button onclick="logAllDimensions()">Log Dimensions</button>
            <button onclick="showModal()" style="background: #28a745;">ðŸŽ¯ Test Modal Replica</button>
        </div>
        
        <div id="status" class="info">Click "Load All Streams" to start testing</div>
        
        <!-- Test 1: Current Problematic Mobile Scaling -->
        <div class="test-section">
            <h2>Test 1: Current Mobile Scaling (Problematic)</h2>
            <div class="info">
                <strong>CSS:</strong> width: auto, height: 100%, object-fit: contain<br>
                <strong>Issue:</strong> This is what the OLD HLS player did for mobile (before fix)
            </div>
            <div class="video-container mobile-scaling">
                <video id="video1" muted playsinline autoplay preload="none"></video>
            </div>
            <div id="status1" class="info">Not loaded</div>
            <div id="dimensions1" class="dimensions">Dimensions: Not loaded</div>
        </div>
        
        <!-- Test 2: Fixed Mobile Scaling -->
        <div class="test-section">
            <h2>Test 2: Fixed Mobile Scaling (object-fit: fill)</h2>
            <div class="info">
                <strong>CSS:</strong> width: 100%, height: 100%, object-fit: fill<br>
                <strong>Fix:</strong> Use full width/height with fill (current HLS fix)
            </div>
            <div class="video-container fixed-mobile-scaling">
                <video id="video2" muted playsinline autoplay preload="none"></video>
            </div>
            <div id="status2" class="info">Not loaded</div>
            <div id="dimensions2" class="dimensions">Dimensions: Not loaded</div>
        </div>
        
        <!-- Test 3: Aspect Ratio Container -->
        <div class="test-section">
            <h2>Test 3: Aspect Ratio Container (9:16)</h2>
            <div class="info">
                <strong>CSS:</strong> aspect-ratio: 9/16, object-fit: contain<br>
                <strong>Approach:</strong> Container enforces mobile aspect ratio
            </div>
            <div class="video-container aspect-ratio-container">
                <video id="video3" muted playsinline autoplay preload="none"></video>
            </div>
            <div id="status3" class="info">Not loaded</div>
            <div id="dimensions3" class="dimensions">Dimensions: Not loaded</div>
        </div>
        
        <!-- Test 4: Responsive Container -->
        <div class="test-section">
            <h2>Test 4: Responsive Container</h2>
            <div class="info">
                <strong>CSS:</strong> width: 100%, height: auto, object-fit: contain<br>
                <strong>Approach:</strong> Let video determine its own height
            </div>
            <div class="video-container responsive-container">
                <video id="video4" muted playsinline autoplay preload="none"></video>
            </div>
            <div id="status4" class="info">Not loaded</div>
            <div id="dimensions4" class="dimensions">Dimensions: Not loaded</div>
        </div>
        
        <!-- Test 5: RecHostStreamModal Exact Replication -->
        <div class="test-section">
            <h2>Test 5: RecHostStreamModal Exact Replication</h2>
            <div class="info">
                <strong>CSS:</strong> width: 100%, height: 100%, object-fit: fill, aspect-ratio: 9/16<br>
                <strong>Approach:</strong> Exact replication of RecHostStreamModal mobile config
            </div>
            <div class="video-container modal-replication">
                <video id="video5" muted playsinline autoplay preload="none"></video>
            </div>
            <div id="status5" class="info">Not loaded</div>
            <div id="dimensions5" class="dimensions">Dimensions: Not loaded</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const streamUrl = 'https://dev.virtualpytest.com/host/stream/capture1/output.m3u8';
        const videos = ['video1', 'video2', 'video3', 'video4', 'video5', 'modalVideo'];
        const hlsInstances = {};
        let isMuted = true;
        let modalRemoteShown = false;
        
        function updateStatus(videoId, message, isError = false) {
            const statusEl = document.getElementById(`status${videoId.slice(-1)}`);
            statusEl.textContent = message;
            statusEl.className = isError ? 'error' : 'success';
        }
        
        function updateGlobalStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'error' : 'info';
        }
        
        function updateDimensions(videoId) {
            const video = document.getElementById(videoId);
            const dimensionsEl = document.getElementById(`dimensions${videoId.slice(-1)}`);
            if (video && dimensionsEl) {
                const info = {
                    videoWidth: video.videoWidth,
                    videoHeight: video.videoHeight,
                    displayWidth: video.offsetWidth,
                    displayHeight: video.offsetHeight,
                    aspectRatio: video.videoWidth && video.videoHeight ? (video.videoWidth / video.videoHeight).toFixed(2) : 'N/A'
                };
                dimensionsEl.textContent = `Video: ${info.videoWidth}x${info.videoHeight} | Display: ${info.displayWidth}x${info.displayHeight} | Ratio: ${info.aspectRatio}`;
            }
        }
        
        function loadStream(videoId) {
            const video = document.getElementById(videoId);
            if (!video) return;
            
            // Clean up existing HLS instance
            if (hlsInstances[videoId]) {
                hlsInstances[videoId].destroy();
                delete hlsInstances[videoId];
            }
            
            updateStatus(videoId, 'Loading...');
            
            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    liveSyncDuration: 1,
                    liveMaxLatencyDuration: 3,
                    maxBufferLength: 2,
                    maxMaxBufferLength: 4,
                    backBufferLength: 0,
                    maxBufferSize: 2 * 1000 * 1000,
                    maxBufferHole: 0.1,
                    fragLoadingTimeOut: 5000,
                    manifestLoadingTimeOut: 3000,
                    levelLoadingTimeOut: 3000,
                    liveBackBufferLength: 0,
                    liveDurationInfinity: true,
                });
                
                hlsInstances[videoId] = hls;
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    updateStatus(videoId, 'Stream loaded successfully');
                    video.play().catch(err => {
                        console.warn(`Autoplay failed for ${videoId}:`, err);
                        updateStatus(videoId, 'Loaded (click to play)', false);
                    });
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error(`HLS error for ${videoId}:`, data);
                    if (data.fatal) {
                        updateStatus(videoId, `Fatal error: ${data.details}`, true);
                        // Try native playback
                        tryNativePlayback(videoId);
                    } else {
                        updateStatus(videoId, `Error: ${data.details}`, true);
                    }
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                tryNativePlayback(videoId);
            } else {
                updateStatus(videoId, 'HLS not supported', true);
            }
        }
        
        function tryNativePlayback(videoId) {
            const video = document.getElementById(videoId);
            if (!video) return;
            
            updateStatus(videoId, 'Trying native playback...');
            
            video.addEventListener('loadedmetadata', () => {
                updateStatus(videoId, 'Native playback loaded');
                updateDimensions(videoId);
                video.play().catch(err => {
                    console.warn(`Native autoplay failed for ${videoId}:`, err);
                    updateStatus(videoId, 'Loaded (click to play)', false);
                });
            }, { once: true });
            
            video.addEventListener('error', (e) => {
                updateStatus(videoId, `Native playback error: ${e.message}`, true);
            }, { once: true });
            
            video.src = streamUrl + (streamUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
            video.load();
        }
        
        function loadAllStreams() {
            updateGlobalStatus('Loading all streams...');
            videos.forEach((videoId, index) => {
                setTimeout(() => loadStream(videoId), index * 500); // Stagger loads
            });
            setTimeout(() => {
                updateGlobalStatus('All streams initiated. Check individual statuses below.');
            }, 3000);
        }
        
        function stopAllStreams() {
            updateGlobalStatus('Stopping all streams...');
            videos.forEach(videoId => {
                const video = document.getElementById(videoId);
                if (video) {
                    video.pause();
                    video.src = '';
                    video.load();
                }
                
                if (hlsInstances[videoId]) {
                    hlsInstances[videoId].destroy();
                    delete hlsInstances[videoId];
                }
                
                updateStatus(videoId, 'Stopped');
                const dimensionsEl = document.getElementById(`dimensions${videoId.slice(-1)}`);
                if (dimensionsEl) {
                    dimensionsEl.textContent = 'Dimensions: Stopped';
                }
            });
            updateGlobalStatus('All streams stopped');
        }
        
        function toggleMute() {
            isMuted = !isMuted;
            videos.forEach(videoId => {
                const video = document.getElementById(videoId);
                if (video) {
                    video.muted = isMuted;
                }
            });
            updateGlobalStatus(`All videos ${isMuted ? 'muted' : 'unmuted'}`);
        }
        
        function logAllDimensions() {
            console.log('=== Video Dimensions Report ===');
            videos.forEach(videoId => {
                const video = document.getElementById(videoId);
                if (video) {
                    const info = {
                        id: videoId,
                        videoWidth: video.videoWidth,
                        videoHeight: video.videoHeight,
                        displayWidth: video.offsetWidth,
                        displayHeight: video.offsetHeight,
                        aspectRatio: video.videoWidth && video.videoHeight ? (video.videoWidth / video.videoHeight).toFixed(2) : 'N/A',
                        objectFit: getComputedStyle(video).objectFit
                    };
                    console.log(`${videoId}:`, info);
                    updateDimensions(videoId);
                }
            });
            updateGlobalStatus('Dimensions logged to console');
        }
        
        // Add click-to-play for videos that require user interaction
        videos.forEach(videoId => {
            const video = document.getElementById(videoId);
            if (video) {
                video.addEventListener('click', () => {
                    if (video.paused) {
                        video.play().catch(err => {
                            console.warn(`Manual play failed for ${videoId}:`, err);
                        });
                    }
                });
                
                // Update dimensions when metadata loads
                video.addEventListener('loadedmetadata', () => {
                    updateDimensions(videoId);
                    console.log(`${videoId} loaded:`, {
                        videoWidth: video.videoWidth,
                        videoHeight: video.videoHeight,
                        displayWidth: video.offsetWidth,
                        displayHeight: video.offsetHeight,
                        aspectRatio: (video.videoWidth / video.videoHeight).toFixed(2)
                    });
                });
                
                // Update dimensions on resize
                video.addEventListener('resize', () => {
                    updateDimensions(videoId);
                });
            }
        });
        
        // Modal control functions
        function showModal() {
            document.getElementById('modalTest').style.display = 'flex';
            // Load the modal video
            setTimeout(() => {
                loadStream('modalVideo');
            }, 500);
            console.log('Modal opened - testing exact RecHostStreamModal structure');
        }
        
        function closeModal() {
            document.getElementById('modalTest').style.display = 'none';
            // Stop modal video
            const video = document.getElementById('modalVideo');
            if (video) {
                video.pause();
                video.src = '';
            }
            if (hlsInstances['modalVideo']) {
                hlsInstances['modalVideo'].destroy();
                delete hlsInstances['modalVideo'];
            }
            console.log('Modal closed');
        }
        
        function toggleModalRemote() {
            const container = document.getElementById('modalStreamContainer');
            const panel = document.getElementById('modalRemotePanel');
            const button = event.target;
            
            modalRemoteShown = !modalRemoteShown;
            
            if (modalRemoteShown) {
                container.style.width = '75%';
                panel.style.display = 'block';
                button.textContent = 'Hide Remote';
                console.log('Modal remote panel shown - stream width: 75%');
            } else {
                container.style.width = '100%';
                panel.style.display = 'none';
                button.textContent = 'Show Remote';
                console.log('Modal remote panel hidden - stream width: 100%');
            }
        }
        
        // Handle escape key for modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Log when page loads
        console.log('HLS Mobile Scaling Test initialized');
        console.log('Stream URL:', streamUrl);
        console.log('Available tests:', videos.length);
        console.log('ðŸŽ¯ Click "Test Modal Replica" to test exact RecHostStreamModal structure');
    </script>
</body>
</html>
