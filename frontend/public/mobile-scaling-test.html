<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Scaling Parameter Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .controls {
            background: #222;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            color: #ccc;
            font-weight: 500;
        }

        select, input, button {
            padding: 8px 12px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #007bff;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button.load {
            background: #28a745;
        }

        button.stop {
            background: #dc3545;
        }

        .players-container {
            display: block;
            margin-bottom: 20px;
        }

        .player-section {
            background: #111;
            border-radius: 8px;
            overflow: hidden;
        }

        .player-header {
            background: #333;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #555;
        }

        .player-status.loading { background: #ff9800; }
        .player-status.success { background: #4caf50; }
        .player-status.error { background: #f44336; }

        /* Modal Container - Exact RecHostStreamModal replication */
        .modal-container {
            width: 95vw;
            height: 90vh;
            background: #1e1e1e;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 0 auto;
        }

        .modal-header {
            padding: 8px 16px;
            background: #2d2d2d;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 48px;
            border-radius: 8px 8px 0 0;
        }

        .modal-main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: black;
            position: relative;
        }

        .stream-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: black;
        }
        
        .stream-container.mobile {
            align-items: flex-start;
            padding-top: 8px;
        }

        .stream-container.with-remote {
            width: 75%;
        }

        .remote-panel {
            width: 25%;
            background: #2d2d2d;
            border-left: 1px solid #555;
            padding: 16px;
            display: none;
        }

        .remote-panel.show {
            display: block;
        }

        .video-player {
            background: black;
            display: block;
        }

        .dimensions-info {
            background: #222;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .sync-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sync-checkbox {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mobile Scaling Parameter Test</h1>
        <p>Testing: <code>https://dev.virtualpytest.com/host/stream/capture1/output.m3u8</code></p>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label>Width</label>
                <select id="width">
                    <option value="100%">100%</option>
                    <option value="auto">auto</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Height</label>
                <select id="height">
                    <option value="100%">100%</option>
                    <option value="auto">auto</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Object Fit</label>
                <select id="objectFit">
                    <option value="fill">fill</option>
                    <option value="contain">contain</option>
                    <option value="cover">cover</option>
                </select>
            </div>

            <div class="control-group">
                <label>Aspect Ratio</label>
                <select id="aspectRatio">
                    <option value="9/16">9:16 (Mobile)</option>
                    <option value="16/9">16:9 (Desktop)</option>
                    <option value="none">None</option>
                </select>
            </div>

            <div class="control-group">
                <label>Mobile Mode</label>
                <select id="mobileMode">
                    <option value="true">Mobile (flex-start + padding)</option>
                    <option value="false">Desktop (center)</option>
                </select>
            </div>

            <div class="control-group">
                <button onclick="applySettings()" class="load">Apply Settings</button>
            </div>

            <div class="control-group">
                <button onclick="loadStream()" class="load">Load Stream</button>
            </div>

            <div class="control-group">
                <button onclick="stopStream()" class="stop">Stop Stream</button>
            </div>

            <div class="control-group">
                <button onclick="toggleRemote()">Toggle Remote (75%)</button>
            </div>
        </div>

        <!-- Single Player -->
        <div class="players-container">
            <div class="player-section">
                <div class="player-header">
                    Mobile Scaling Test (width: 100%, height: 100%, object-fit: fill)
                    <span class="player-status" id="status">Not loaded</span>
                </div>
                <div class="modal-container">
                    <div class="modal-header">
                        <span>S21x - Live Stream</span>
                        <span style="font-size: 12px;">Parameter Test</span>
                    </div>
                    <div class="modal-main-content">
                        <div class="stream-container" id="container">
                            <video id="video" class="video-player" 
                                   style="width: 100%; height: 100%; object-fit: fill; aspect-ratio: 9/16;"
                                   muted playsinline autoplay preload="none"></video>
                        </div>
                        <div class="remote-panel" id="remote">
                            <h4>Remote Panel</h4>
                            <p>Simulated remote control</p>
                            <p>Stream width: 75%</p>
                        </div>
                    </div>
                </div>
                <div class="dimensions-info" id="dimensions">Dimensions: Not loaded</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const streamUrl = 'https://dev.virtualpytest.com/host/stream/capture1/output.m3u8';
        let hlsInstance = null;
        let remoteShown = false;

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `player-status ${type}`;
        }

        function updateDimensions() {
            const video = document.getElementById('video');
            const dimensionsEl = document.getElementById('dimensions');
            if (video && dimensionsEl) {
                const info = {
                    videoWidth: video.videoWidth || 0,
                    videoHeight: video.videoHeight || 0,
                    displayWidth: video.offsetWidth || 0,
                    displayHeight: video.offsetHeight || 0,
                    aspectRatio: video.videoWidth && video.videoHeight ? (video.videoWidth / video.videoHeight).toFixed(2) : 'N/A'
                };
                dimensionsEl.innerHTML = `
                    Video: ${info.videoWidth}x${info.videoHeight}<br>
                    Display: ${info.displayWidth}x${info.displayHeight}<br>
                    Ratio: ${info.aspectRatio}<br>
                    CSS: ${getComputedStyle(video).width} x ${getComputedStyle(video).height}<br>
                    Object-fit: ${getComputedStyle(video).objectFit}
                `;
            }
        }

        function loadStream() {
            const video = document.getElementById('video');
            if (!video) return;

            // Clean up existing HLS instance
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }

            updateStatus('Loading...', 'loading');

            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    liveSyncDuration: 1,
                    liveMaxLatencyDuration: 3,
                    maxBufferLength: 2,
                    maxMaxBufferLength: 4,
                });

                hlsInstance = hls;

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    updateStatus('Loaded', 'success');
                    video.play().catch(err => {
                        console.warn('Autoplay failed:', err);
                        updateStatus('Click to play', 'success');
                    });
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        updateStatus(`Error: ${data.details}`, 'error');
                    }
                });

                hls.loadSource(streamUrl);
                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', () => {
                    updateStatus('Loaded (Native)', 'success');
                    updateDimensions();
                }, { once: true });
                video.load();
            } else {
                updateStatus('HLS not supported', 'error');
            }
        }

        function applySettings() {
            // Get settings
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const objectFit = document.getElementById('objectFit').value;
            const aspectRatio = document.getElementById('aspectRatio').value;
            const mobileMode = document.getElementById('mobileMode').value === 'true';

            // Apply to video
            const video = document.getElementById('video');
            const container = document.getElementById('container');
            
            video.style.width = width;
            video.style.height = height;
            video.style.objectFit = objectFit;
            
            if (aspectRatio !== 'none') {
                video.style.aspectRatio = aspectRatio;
            } else {
                video.style.aspectRatio = '';
            }

            // Apply mobile mode to container
            if (mobileMode) {
                container.classList.add('mobile');
            } else {
                container.classList.remove('mobile');
            }

            // Update header
            document.querySelector('.player-header').innerHTML = `
                Mobile Scaling Test (width: ${width}, height: ${height}, object-fit: ${objectFit})
                <span class="player-status" id="status">${document.getElementById('status').textContent}</span>
            `;

            // Update dimensions
            setTimeout(() => {
                updateDimensions();
            }, 100);

            console.log('Settings applied:', {
                width, height, objectFit, aspectRatio, mobileMode
            });
        }

        function stopStream() {
            const video = document.getElementById('video');
            if (video) {
                video.pause();
                video.src = '';
            }
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }
            updateStatus('Stopped', 'info');
            document.getElementById('dimensions').textContent = 'Dimensions: Stopped';
        }

        function toggleRemote() {
            remoteShown = !remoteShown;
            
            const container = document.getElementById('container');
            const remote = document.getElementById('remote');
            
            if (remoteShown) {
                container.classList.add('with-remote');
                remote.classList.add('show');
            } else {
                container.classList.remove('with-remote');
                remote.classList.remove('show');
            }
            
            // Update dimensions after width change
            setTimeout(() => {
                updateDimensions();
            }, 100);
            
            console.log(`Remote panel ${remoteShown ? 'shown' : 'hidden'} - stream width: ${remoteShown ? '75%' : '100%'}`);
        }

        // Add event listeners for video
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            if (video) {
                video.addEventListener('loadedmetadata', () => {
                    updateDimensions();
                });
                video.addEventListener('click', () => {
                    if (video.paused) {
                        video.play();
                    }
                });
            }
        });

        console.log('Mobile Scaling Parameter Test initialized');
        console.log('Stream URL:', streamUrl);
    </script>
</body>
</html>
