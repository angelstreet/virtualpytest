# VirtualPyTest Backend Host Only
# Device controller for hardware interface - connects to external backend_server
# Use: docker-compose -f docker-compose.backend-host.yml up

services:
  # Backend Host - Device Controller (includes shared library)
  backend_host:
    build:
      context: ../../
      dockerfile: backend_host/Dockerfile
    container_name: virtualpytest-backend-host
    hostname: backend-host-standalone
    ports:
      - "6109:80"  # External port 6109 maps to internal port 80
    volumes:
      - /dev:/dev  # Hardware access for device control
      - ../../.env:/app/.env:ro  # Shared environment variables (project root)
      - ../src/.env:/app/backend_host/src/.env:ro  # Host-specific .env
    tmpfs:
      - /var/www/html/stream/capture1/hot:size=200M,mode=777  # RAM-based hot storage
    environment:
      - XDG_CONFIG_HOME=/tmp/.chromium
      - XDG_CACHE_HOME=/tmp/.chromium
      - XDG_RUNTIME_DIR=/tmp/.chromium
      - HOST_PORT=6109
      - HOST_NAME=${HOST_NAME:-docker-host-1}
      - HOST_URL=http://localhost:6109
      - DEBUG=false
      
      # External Backend Server Configuration
      # Configure these in your .env file
      - SERVER_URL=${SERVER_URL:-http://your-backend-server:5109}
      
      # External Supabase Database Configuration (optional - for direct DB access)
      # Configure these in your .env file if host needs direct database access
      - SUPABASE_DB_URI=${SUPABASE_DB_URI}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      
      # Device Configuration
      # Configure these in your .env file for your specific hardware
      - DEVICE1_NAME=${DEVICE1_NAME}
      - DEVICE1_MODEL=${DEVICE1_MODEL}
      - DEVICE1_VIDEO=${DEVICE1_VIDEO}
      - DEVICE1_AUDIO=${DEVICE1_AUDIO}
      - DEVICE1_REMOTE=${DEVICE1_REMOTE}
      
    command: sh -c "sleep 10 && /app/backend_host/docker/scripts/entrypoint.sh"
    privileged: true  # Required for hardware access
    security_opt:
      - seccomp=unconfined
      - apparmor=unconfined
    restart: unless-stopped

networks:
  default:
    name: virtualpytest-backend-host-network
    driver: bridge
