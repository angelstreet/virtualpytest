# VirtualPyTest Hetzner Setup - Summary

## What We've Implemented

### 1. ✅ Dynamic Host Scaling (setup.sh)
- Configure N hosts via `config.env` (HOST_MAX)
- Automatically generates nginx config for all hosts
- Generates docker-compose.yml with all services
- Creates individual .env files for each host
- Auto-deploys nginx configuration

### 2. ✅ Two-Tier Nginx Architecture
**Host Nginx (Ubuntu):**
- SSL termination (Let's Encrypt)
- Routes requests to Docker containers
- Handles /server/, /hostN/, /grafana/, /websockify

**Container Nginx (Inside each backend_host):**
- Serves video stream files (hot/cold storage)
- Proxies to Flask API
- Proxies to NoVNC
- Handles WebSocket connections

### 3. ✅ Video Stream Exposure
Each host now has proper nginx routing for:
- `/hostN/stream/` - HLS video streams
- `/hostN/captures/` - Captured images
- Hot/cold storage fallback (RAM → Disk)
- Full CORS headers for browser access
- Resource types: captures, thumbnails, segments, metadata, audio, transcript

**Request Flow:**
```
Browser → Host Nginx (HTTPS) → Container Nginx → Filesystem
  https://domain/host1/stream/capture1/segments/playlist.m3u8
    ↓ rewrites to
  /host/stream/capture1/segments/playlist.m3u8
    ↓ serves from
  /var/www/html/stream/capture1/hot/segments/playlist.m3u8 (RAM)
    or fallback to
  /var/www/html/stream/capture1/segments/playlist.m3u8 (disk)
```

### 4. ✅ Optional VPN Support
**Simple config-based:**
- WireGuard installed automatically (lightweight, ~1MB)
- Enable/disable via `USE_VPN=true/false` in config.env
- Auto-starts VPN if config exists at `/etc/wireguard/wg0.conf`
- Shows current public IP
- Enables VPN on boot
- Detects if already running

**Usage:**
```bash
# 1. Get free config from ProtonVPN
# 2. Upload to server:
scp ~/Downloads/proton.conf root@SERVER_IP:~/vpn.conf

# 3. Install:
sudo cp ~/vpn.conf /etc/wireguard/wg0.conf
sudo chmod 600 /etc/wireguard/wg0.conf

# 4. Enable in config.env:
USE_VPN=true

# 5. Run setup:
./setup.sh
```

## File Structure

```
setup/docker/hetzner_custom/
├── config.env              # Main configuration (HOST_MAX, USE_VPN)
├── setup.sh                # Generates all configs, installs deps
├── launch.sh               # Starts Docker containers
├── docker-compose.yml      # Generated by setup.sh
├── host-nginx.conf         # Generated by setup.sh
├── README.md               # Complete deployment guide
├── VPN_SETUP.md           # VPN setup instructions
└── SUMMARY.md             # This file

backend_host_1/.env         # Generated by setup.sh
backend_host_2/.env         # Generated by setup.sh
backend_host_N/.env         # Generated by setup.sh
```

## Configuration Files

### config.env
```bash
HOST_MAX=4                           # Number of hosts (1-10)
HOST_START_PORT=6109                 # Starting port
DOMAIN=api.virtualpytest.com         # Public domain
SERVER_PORT=5109                     # Backend server port
USE_VPN=false                        # Enable VPN
```

### Generated: host-nginx.conf
- HTTP → HTTPS redirect
- SSL configuration (Let's Encrypt)
- Server API: `/server/` → port 5109
- Grafana: `/grafana/` → port 3000
- Per-host routing:
  - `/host1/stream/` → Video files
  - `/host1/captures/` → Captures
  - `/host1/websockify` → VNC WebSocket
  - `/host1/` → General API

### Generated: docker-compose.yml
- 1× backend_server (port 5109, 3000)
- N× backend_host_N (ports 6109, 6110, ...)
- Shared network: hetzner_network
- Grafana volumes (persistent)
- tmpfs for hot storage (RAM)

### Generated: backend_host_N/.env
```bash
SERVER_URL=http://backend_server:5109
HOST_NAME=hetzner-host-N
HOST_PORT=6109
HOST_URL=http://backend_host_N:80
HOST_VIDEO_CAPTURE_PATH=/var/www/html/stream/captureN
HOST_VNC_STREAM_PATH=https://domain/hostN/vnc/vnc_lite.html?path=/hostN/websockify
```

## Setup Process

### One-Time Setup
```bash
# 1. Clone repository
git clone https://github.com/angelstreet/virtualpytest.git
cd virtualpytest

# 2. Create main .env file
cp setup/docker/hetzner_custom/env.example .env
nano .env  # Add Supabase credentials

# 3. (Optional) Setup VPN
scp ~/Downloads/vpn.conf root@SERVER_IP:~/vpn.conf
ssh root@SERVER_IP
sudo cp ~/vpn.conf /etc/wireguard/wg0.conf
sudo chmod 600 /etc/wireguard/wg0.conf

# 4. Configure hosts
cd setup/docker/hetzner_custom
nano config.env  # Set HOST_MAX, USE_VPN

# 5. Run setup
./setup.sh
```

### Launch Services
```bash
cd setup/docker/hetzner_custom
./launch.sh
```

## Access Points

### Local (Development)
- Backend Server: http://localhost:5109
- Grafana: http://localhost:3000
- Host 1: http://localhost:6109
- Host 2: http://localhost:6110

### Public (Production)
- Backend Server API: https://domain/server/
- Grafana: https://domain/grafana/
- Host 1 API: https://domain/host1/
- Host 1 VNC: https://domain/host1/vnc/vnc_lite.html
- Host 1 Streams: https://domain/host1/stream/
- Host 2 API: https://domain/host2/
- Host 2 VNC: https://domain/host2/vnc/vnc_lite.html
- Host 2 Streams: https://domain/host2/stream/

## Key Features

### Scalability
- Scale from 1 to 10+ hosts
- Single config file change (HOST_MAX)
- Automatic resource detection
- Memory usage warnings

### Video Streaming
- Hot/cold storage (RAM + Disk)
- HLS format support
- CORS enabled
- Multiple resource types
- Automatic fallback

### VPN Support
- Country-based IP routing
- Free VPN options (ProtonVPN)
- Easy enable/disable
- Auto-start on boot
- IP verification

### Monitoring
- Grafana dashboards
- Container health checks
- Service supervision
- Log aggregation

### Security
- SSL/TLS termination
- Secure VPN configs
- Container isolation
- Privileged mode (hardware access)

## Resource Requirements

### Per Host
- RAM: ~300-400MB
- CPU: 1 core (shared)
- Disk: ~500MB (without recordings)
- Network: Minimal (local Docker network)

### Recommended Server Specs
- **4GB RAM**: Up to 6 hosts
- **8GB RAM**: Up to 10 hosts
- **16GB RAM**: 20+ hosts

### Hetzner Server Options
- **CX21** (2 vCPU, 4GB RAM): ~€5/month → 6 hosts
- **CX31** (2 vCPU, 8GB RAM): ~€10/month → 10 hosts
- **CX41** (4 vCPU, 16GB RAM): ~€20/month → 20+ hosts

## Common Operations

### Add More Hosts
```bash
# Edit config
nano config.env  # Increase HOST_MAX

# Regenerate configs
./setup.sh

# Restart services
./launch.sh
```

### Change VPN Country
```bash
# Download new config
# Upload and install
sudo cp ~/new-country.conf /etc/wireguard/wg0.conf

# Restart VPN
sudo wg-quick down wg0
sudo wg-quick up wg0

# Verify
curl ifconfig.me
```

### View Logs
```bash
# All services
docker-compose -f docker-compose.yml logs -f

# Specific service
docker logs -f virtualpytest-backend-host-1

# Inside container
docker exec -it virtualpytest-backend-host-1 tail -f /var/log/supervisor/flask-stdout.log
```

### Stop Services
```bash
docker-compose -f docker-compose.yml down
```

### Restart Nginx
```bash
sudo systemctl reload nginx
```

## Troubleshooting

### Video Streams Not Loading
1. Check container nginx is running:
   ```bash
   docker exec virtualpytest-backend-host-1 supervisorctl status nginx
   ```

2. Check file permissions:
   ```bash
   docker exec virtualpytest-backend-host-1 ls -la /var/www/html/stream/
   ```

3. Test direct access:
   ```bash
   curl -I http://localhost:6109/host/stream/capture1/segments/
   ```

### VPN Not Working
1. Check WireGuard status:
   ```bash
   sudo wg show
   ```

2. Check config:
   ```bash
   sudo cat /etc/wireguard/wg0.conf
   ```

3. Check IP:
   ```bash
   curl ifconfig.me
   ```

### Nginx Errors
1. Test configuration:
   ```bash
   sudo nginx -t
   ```

2. Check logs:
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

## Next Steps

1. ✅ Test video streaming from all hosts
2. ✅ Verify VNC access
3. ✅ Configure Grafana dashboards
4. ✅ Setup frontend connection
5. ✅ Add monitoring alerts
6. ✅ Configure backup strategy

