# VirtualPyTest Hetzner Custom Deployment

**1 Backend Server + 2 Backend Hosts Configuration**

---

## ğŸš€ Quick Start from Scratch

### 1. Clone Repository

```bash
# Clone VirtualPyTest from GitHub
git clone https://github.com/angelstreet/virtualpytest.git
cd virtualpytest
```

### 2. Install Docker

```bash
# Run Docker installation script
./setup/docker/install_docker.sh
```

### 3. Configure Environment

âš ï¸ **Important: Configuration Files**

This deployment uses **`config.env`** (git-ignored) for dynamic configuration:
- `config.env.example` - Template committed to git (DO NOT EDIT)
- `config.env` - Your local config (git-ignored, edit this)
- Setup automatically copies `config.env.example` â†’ `config.env` on first run

**Three separate .env files are required:**

```bash
# 1. Deployment configuration (auto-generated on first run)
cd setup/docker/hetzner_custom
./setup.sh   # Creates config.env from config.env.example
nano config.env  # Edit: HOST_MAX, ENABLE_GRAFANA, USE_VPN, etc.

# 2. Server configuration (project root)
cp setup/docker/hetzner_custom/env.example .env
nano .env  # Add Supabase credentials

# 3. Host configurations (auto-generated by setup.sh)
# backend_host_1/.env, backend_host_2/.env, etc.
# These are created automatically based on config.env settings
```

**Configuration files:**
- **`config.env`** - Deployment settings (hosts count, Grafana, VPN)
- **`.env`** - Server configuration (Supabase, API keys)
- **`backend_host_*/.env`** - Auto-generated host configs

**Available options in config.env:**
```bash
HOST_MAX=4                  # Number of hosts (1-10)
HOST_START_PORT=6109       # Starting port (incremental)
DOMAIN=api.virtualpytest.com
SERVER_PORT=5109
ENABLE_GRAFANA=false       # Optional: Enable Grafana monitoring
GRAFANA_PORT=3000
USE_VPN=false              # Optional: Enable WireGuard VPN
```

### 4. Setup Let's Encrypt SSL (Required for HTTPS)

```bash
# Install certbot
apt update && apt install certbot python3-certbot-nginx -y

# Get SSL certificate (replace with your email)
certbot --nginx -d api.virtualpytest.com --non-interactive --agree-tos --email your-email@example.com

# Verify auto-renewal is configured
systemctl status certbot.timer

# Test renewal (dry run)
certbot renew --dry-run
```

**DNS Setup:**
- In your DNS provider (Namecheap), add an A record:
- `api.virtualpytest.com` â†’ Your Hetzner server IP (e.g., `162.55.54.38`)
- Wait 5-10 minutes for DNS propagation before running certbot

### 5. Configure Ubuntu Nginx

```bash
# Run setup to generate configs (nginx, docker-compose, host .env files)
cd setup/docker/hetzner_custom
./setup.sh

# Copy nginx config to Ubuntu
sudo cp host-nginx.conf /etc/nginx/sites-available/virtualpytest

# Enable site
sudo ln -sf /etc/nginx/sites-available/virtualpytest /etc/nginx/sites-enabled/virtualpytest
sudo rm -f /etc/nginx/sites-enabled/default

# Test and reload
sudo nginx -t
sudo systemctl reload nginx
```

**What setup.sh does:**
- âœ… Copies `config.env.example` â†’ `config.env` (if not exists)
- âœ… Generates nginx config with N hosts (based on `HOST_MAX`)
- âœ… Generates `docker-compose.yml` with optional Grafana
- âœ… Creates `backend_host_*/.env` files for each host
- âœ… Configures VPN if enabled
- âœ… Sets up swap memory

**Important: VNC WebSocket Configuration**

The `host-nginx.conf` includes critical WebSocket routing for VNC access:
- `/host1/websockify` â†’ Routes to Host 1 VNC WebSocket (port 6109)
- `/host2/websockify` â†’ Routes to Host 2 VNC WebSocket (port 6110)

These routes **must be defined BEFORE** the general `/host1/` and `/host2/` location blocks to ensure nginx matches the WebSocket path correctly. Without these, VNC Lite will fail with "connection is closed" error.

### 6. Launch Services

```bash
# Launch 1 server + 2 hosts
./setup/docker/hetzner_custom/launch.sh
```

**That's it!** Your VirtualPyTest deployment is running. ğŸ‰

Access points:
- **Backend Server API**: http://localhost:5109 or https://api.virtualpytest.com/server/
- **Grafana Monitoring**: http://localhost:3000 or https://api.virtualpytest.com/grafana/ (if enabled)
- **Backend Host 1**: http://localhost:6109 or https://api.virtualpytest.com/host1/
- **Backend Host 2+**: Ports 6110, 6111, etc. (based on `HOST_MAX` in config.env)
- **VNC Host 1**: https://api.virtualpytest.com/host1/vnc/vnc_lite.html
- **VNC Host 2+**: https://api.virtualpytest.com/host2/vnc/vnc_lite.html, etc.

**Note:** Number of hosts and Grafana availability depends on your `config.env` settings.

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backend Server (Centralized)            â”‚
â”‚  - Flask API (Port 5109)                        â”‚
â”‚  - Connects to Supabase Database                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ Backend Host 1 â”‚            â”‚ Backend Host 2 â”‚     â”‚
â”‚  Port: 6109    â”‚            â”‚  Port: 6110    â”‚ ... â”‚ (+ more hosts)
â”‚  Device: TV #1 â”‚            â”‚  Device: TV #2 â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Grafana (Optional)                    â”‚
â”‚  - Monitoring Dashboard (Port 3000)             â”‚
â”‚  - Enable via ENABLE_GRAFANA=true               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- ğŸ”¢ **Dynamic Hosts**: Deploy 1-10 hosts (set via `HOST_MAX` in config.env)
- ğŸ“Š **Optional Grafana**: Enable/disable per server (set via `ENABLE_GRAFANA`)
- ğŸŒ **Optional VPN**: WireGuard support (set via `USE_VPN`)
- ğŸ”§ **Auto-generated configs**: Nginx, docker-compose, and host .env files

### Two-Tier Nginx Architecture

VirtualPyTest uses a **2-tier nginx architecture** to handle SSL termination and route requests to Docker containers:

#### Tier 1: Host Nginx (Ubuntu Server)
- **Location**: `/etc/nginx/sites-available/virtualpytest` (on the server itself, NOT in Docker)
- **Purpose**: SSL termination, public HTTPS endpoint, request routing
- **Port**: 443 (HTTPS) and 80 (HTTP redirect)
- **Generated by**: `setup.sh` creates `host-nginx.conf`

**What it does:**
- Terminates SSL/TLS (Let's Encrypt certificates)
- Routes `/server/*` â†’ Backend Server (port 5109)
- Routes `/host1/*` â†’ Backend Host 1 container (port 6109)
- Routes `/host2/*` â†’ Backend Host 2 container (port 6110)
- Routes `/grafana/*` â†’ Grafana (port 3000)

#### Tier 2: Container Nginx (Inside Each Backend Host)
- **Location**: Inside Docker containers at `/etc/nginx/sites-available/default`
- **Purpose**: Serve static files, proxy to internal services
- **Port**: 80 (internal, not exposed)
- **Configuration**: `backend_host/docker/nginx.conf`

**What it does:**
- Serves video stream files from `/var/www/html/stream/` (hot/cold storage)
- Proxies VNC requests to NoVNC (port 6080)
- Proxies API requests to Flask (port 6109 internal)
- Handles WebSocket connections for VNC

### Request Flow Examples

**Example 1: Video Stream File**
```
Browser: GET https://api.virtualpytest.com/host1/stream/capture1/segments/playlist.m3u8
    â†“
Host Nginx (port 443, SSL)
    â†“ rewrites /host1/stream/* â†’ /host/stream/*
    â†“ proxies to 127.0.0.1:6109
Container Nginx (backend_host_1, port 80)
    â†“ serves from filesystem
/var/www/html/stream/capture1/hot/segments/playlist.m3u8 (RAM)
    or â†“ fallback
/var/www/html/stream/capture1/segments/playlist.m3u8 (disk)
```

**Example 2: API Request**
```
Browser: POST https://api.virtualpytest.com/host1/device/control
    â†“
Host Nginx (port 443, SSL)
    â†“ rewrites /host1/* â†’ /host/*
    â†“ proxies to 127.0.0.1:6109
Container Nginx (backend_host_1, port 80)
    â†“ proxies to Flask
Flask API (127.0.0.1:6109 internal)
    â†“ processes request
```

**Example 3: VNC WebSocket**
```
Browser: WS https://api.virtualpytest.com/host1/websockify
    â†“
Host Nginx (port 443, SSL + WebSocket Upgrade)
    â†“ rewrites /host1/websockify â†’ /websockify
    â†“ proxies to 127.0.0.1:6109
Container Nginx (backend_host_1, port 80)
    â†“ proxies WebSocket to NoVNC
NoVNC WebSocket Proxy (port 6080)
    â†“ connects to
x11vnc VNC Server (port 5901)
    â†“ displays from
Xvfb Virtual Display (:1)
```

**Why Two Nginx Layers?**
- **Host Nginx**: Handles SSL certificates (Let's Encrypt), public internet access
- **Container Nginx**: Isolated inside Docker, serves files from container filesystem, manages internal routing
- **Benefits**: Security isolation, easier SSL management, hot/cold storage access from inside container

## What's Included

- âœ… **1 Backend Server** - Centralized API and monitoring
- âœ… **2 Backend Hosts** - Distributed device controllers with VNC access
- âœ… **Supabase Database** - External cloud database
- âœ… **Shared Network** - All services communicate via Docker network
- âœ… **NoVNC Web Access** - Browser-based remote desktop for each host

## Ports

- **5109** - Backend Server API
- **3000** - Grafana Monitoring Dashboard
- **6109** - Backend Host 1 Device Controller
- **6110** - Backend Host 2 Device Controller

## Prerequisites

1. **Linux Server** (Ubuntu 20.04+ recommended) or local machine
2. **Docker & Docker Compose** (installed via `install_docker.sh`)
3. **Supabase account** with database configured ([Get Started](https://supabase.com))
4. **Hardware access** for device controllers (HDMI capture cards, etc.)
5. **Git** for cloning repository

## Detailed Setup Guide

### 1. Clone and Setup

**Clone Repository:**
```bash
# Clone from GitHub
git clone https://github.com/angelstreet/virtualpytest.git
cd virtualpytest

# Make scripts executable
chmod +x setup/docker/install_docker.sh
chmod +x setup/docker/hetzner_custom/launch.sh
```

**Install Docker:**
```bash
# Install Docker and Docker Compose
./setup/docker/install_docker.sh

# Verify installation
docker --version
docker compose version
```

### 2. Configure Environment

**Single .env file for all services:**
```bash
# Copy environment template (contains server + hosts config)
cp setup/docker/hetzner_custom/env.example .env

# Edit with your Supabase and device configuration
nano .env
```

**Note:** All services (server + both hosts) load from the same `.env` file in project root.

### 3. Launch Services

**Easy Way (Recommended):**
```bash
# Launch with automated script
./setup/docker/hetzner_custom/launch.sh
```

**Manual Way:**
```bash
# Start all services (1 server + 2 hosts)
docker-compose -f setup/docker/hetzner_custom/docker-compose.yml up -d

# View logs
docker-compose -f setup/docker/hetzner_custom/docker-compose.yml logs -f

# Stop services
docker-compose -f setup/docker/hetzner_custom/docker-compose.yml down
```

### 4. Verify Services

```bash
# Check Backend Server
curl http://localhost:5109/health

# Check Backend Host 1
curl http://localhost:6109/health

# Check Backend Host 2
curl http://localhost:6110/health

# Access Grafana
open http://localhost:3000
```

## Enable HTTPS on a Subdomain (Recommended for Vercel)

Use a public HTTPS URL (e.g., `https://api.yourdomain.com`) that proxies to the backend server (port 5109).

1) DNS (at your registrar, e.g., Namecheap)
```
Type: A
Host: api
Value: <YOUR_SERVER_PUBLIC_IP>   # e.g., 162.55.54.38
TTL:  Automatic
```

2) Nginx on your server (Ubuntu)
```
sudo apt update && sudo apt install -y nginx
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Create site
sudo tee /etc/nginx/sites-available/api.yourdomain.com >/dev/null <<'CONF'
server {
  listen 80;
  server_name api.yourdomain.com;

  # Backend Server routes
  location /server/ {
    proxy_pass http://127.0.0.1:5109;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 180s;
  }

  location /health {
    proxy_pass http://127.0.0.1:5109;
    proxy_set_header Host $host;
  }

  # Backend Host 1 routes (rewrite /host1/ to /host/)
  location /host1/ {
    rewrite ^/host1/(.*)$ /host/$1 break;
    proxy_pass http://127.0.0.1:6109;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 3600s;
  }

  # Backend Host 2 routes (rewrite /host2/ to /host/)
  location /host2/ {
    rewrite ^/host2/(.*)$ /host/$1 break;
    proxy_pass http://127.0.0.1:6110;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 3600s;
  }

  # Default route to backend server
  location / {
    proxy_pass http://127.0.0.1:5109;
    proxy_set_header Host $host;
  }
}
CONF

sudo ln -sf /etc/nginx/sites-available/api.yourdomain.com /etc/nginx/sites-enabled/api.yourdomain.com
sudo nginx -t && sudo systemctl reload nginx
```

3) TLS (Let's Encrypt)
```
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d api.yourdomain.com --redirect --agree-tos -m you@example.com -n
```

4) Verify
```
curl https://api.yourdomain.com/health
curl https://api.yourdomain.com/server/system/getAllHosts
```

Once HTTPS is working, use `https://api.yourdomain.com` in your frontend environment (e.g., Vercel).

## Configuration Details

### Backend Server

The backend server runs centralized:
- **API endpoints** for frontend and hosts
- **Grafana monitoring** for all services
- **Database connection** to Supabase
- **CORS configuration** for frontend access

### Backend Host 1

First device controller:
- **Port**: 6109 (external), 80 (internal)
- **Hostname**: backend-host-1
- **Connects to**: Backend Server via Docker network
- **Hardware access**: `/dev` mounted for device control

### Backend Host 2

Second device controller:
- **Port**: 6110 (external), 80 (internal)
- **Hostname**: backend-host-2
- **Connects to**: Backend Server via Docker network
- **Hardware access**: `/dev` mounted for device control

## Environment Variables

### Required for Backend Server

```bash
SUPABASE_DB_URI=postgresql://...
NEXT_PUBLIC_SUPABASE_URL=https://...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
GRAFANA_ADMIN_PASSWORD=...
```

### Required for Backend Hosts

```bash
# Host 1
HOST1_NAME=hetzner-host-1
HOST1_DEVICE1_NAME=Samsung_TV_Location_1
HOST1_DEVICE1_VIDEO=/dev/video0

# Host 2
HOST2_NAME=hetzner-host-2
HOST2_DEVICE1_NAME=LG_TV_Location_2
HOST2_DEVICE1_VIDEO=/dev/video0
```

See `.env.example` for complete configuration.

## Scaling

### Add More Hosts

To add additional hosts, edit `docker-compose.yml`:

```yaml
backend_host_3:
  build:
    context: ../../../
    dockerfile: backend_host/Dockerfile
  container_name: virtualpytest-backend-host-3
  ports:
    - "6111:6109"  # Next available port
  environment:
    - HOST_NAME=hetzner-host-3
    - HOST_URL=http://localhost:6111
    # ... additional config
```

### Multiple Servers (Load Balancing)

For multiple backend servers, use a load balancer (nginx, HAProxy) in front of multiple server instances.

## VNC Remote Desktop Access

Each backend host includes a NoVNC web-based remote desktop accessible via browser.

### Access VNC

**Host 1:**
```
https://api.virtualpytest.com/host1/vnc/vnc_lite.html
```

**Host 2:**
```
https://api.virtualpytest.com/host2/vnc/vnc_lite.html
```

### VNC Architecture

```
Browser (vnc_lite.html)
  â†“ HTTPS
Host Nginx (/host1/vnc/)
  â†“ Rewrite to /host/vnc/
Container Nginx (port 80) â†’ NoVNC (port 6080)
  â†“ WebSocket
Host Nginx (/host1/websockify)
  â†“ Rewrite to /websockify  
Container Nginx â†’ WebSocket Proxy (port 6080)
  â†“
x11vnc VNC Server (port 5901)
  â†“
Xvfb Virtual Display (:1)
```

### Verify VNC Services

```bash
# Check supervisor status inside container
docker exec -it virtualpytest-backend-host-1 supervisorctl status

# Expected output:
# fluxbox    RUNNING
# nginx      RUNNING
# novnc      RUNNING
# x11vnc     RUNNING
# xvfb       RUNNING
# flask      RUNNING

# Test NoVNC endpoint
curl -I http://localhost:6109/host/vnc/vnc_lite.html

# Test WebSocket endpoint (should see Upgrade headers)
curl -I -H "Connection: Upgrade" -H "Upgrade: websocket" \
  http://localhost:6109/websockify
```

### Common VNC Issues

**"Connection is closed" error:**
- Cause: WebSocket routing not configured correctly
- Fix: Ensure `/host1/websockify` and `/host2/websockify` routes are in `host-nginx.conf` **BEFORE** general `/host1/` and `/host2/` blocks
- Reload nginx: `sudo systemctl reload nginx`

**Black screen or no display:**
- Check if Xvfb is running: `docker exec -it virtualpytest-backend-host-1 ps aux | grep Xvfb`
- Check display: `docker exec -it virtualpytest-backend-host-1 bash -c "DISPLAY=:1 xdpyinfo"`

**NoVNC not accessible:**
- Check port 6080 inside container: `docker exec -it virtualpytest-backend-host-1 curl -I http://localhost:6080`
- Check NoVNC logs: `docker logs virtualpytest-backend-host-1 | grep novnc`

---

## Troubleshooting

### Services won't start

```bash
# Check Docker status
docker ps -a

# View logs for specific service
docker-compose -f setup/docker/hetzner_custom/docker-compose.yml logs backend_server
docker-compose -f setup/docker/hetzner_custom/docker-compose.yml logs backend_host_1
```

### Database connection issues

```bash
# Test Supabase connection
psql "$SUPABASE_DB_URI"

# Check environment variables loaded
docker-compose -f setup/docker/hetzner_custom/docker-compose.yml config
```

### Hardware access issues

```bash
# Check device permissions
ls -la /dev/video*
ls -la /dev/snd/

# Ensure privileged mode is enabled in docker-compose.yml
```

### Network issues between services

```bash
# Check network
docker network inspect virtualpytest-hetzner-network

# Test connectivity from host to server
docker-compose -f setup/docker/hetzner_custom/docker-compose.yml exec backend_host_1 \
  curl http://backend_server:5109/health
```

## Production Deployment

### Security Checklist

- [ ] Change default Grafana admin password
- [ ] Use strong GRAFANA_SECRET_KEY
- [ ] Configure proper CORS_ORIGINS
- [ ] Secure Supabase credentials
- [ ] Use HTTPS in production
- [ ] Configure firewall rules
- [ ] Enable container auto-restart
- [ ] Set up log rotation

### Monitoring

Access Grafana at `http://your-server:3000`:
- **Username**: admin
- **Password**: `$GRAFANA_ADMIN_PASSWORD` from .env

### Backup

```bash
# Backup Grafana data
docker run --rm --volumes-from virtualpytest-backend-server \
  -v $(pwd)/backup:/backup \
  ubuntu tar czf /backup/grafana-backup.tar.gz /var/lib/grafana

# Restore Grafana data
docker run --rm --volumes-from virtualpytest-backend-server \
  -v $(pwd)/backup:/backup \
  ubuntu tar xzf /backup/grafana-backup.tar.gz -C /
```

## Additional Resources

- **Main Documentation**: See `/docs/` folder
- **Standalone Setup**: See `/setup/docker/standalone_server_host/`
- **Individual Services**: See `/backend_server/docker/` and `/backend_host/docker/`
- **Database Schema**: See `/setup/db/schema/`

## Support

For issues or questions:
1. Check logs: `docker-compose logs -f`
2. Verify environment: `docker-compose config`
3. Test connectivity: `curl http://localhost:5109/health`

