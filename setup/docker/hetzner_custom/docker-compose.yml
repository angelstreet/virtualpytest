# VirtualPyTest Hetzner Custom Deployment
# 1 Backend Server + 2 Backend Hosts
# Note: Uses host-level Nginx (not Docker) for reverse proxy on port 80
# Use: docker-compose --env-file .env -f setup/docker/hetzner_custom/docker-compose.yml up

services:
  # Backend Server - API + Grafana (Centralized)
  backend_server:
    build:
      context: ../../../
      dockerfile: backend_server/Dockerfile
    container_name: virtualpytest-backend-server
    ports:
      - "5109:5109"  # nginx proxy (Flask API + Grafana)
      - "3000:3000"  # Grafana direct access
    volumes:
      - ../../../.env:/app/.env:ro  # Shared environment variables (project root)
      - grafana-data:/var/lib/grafana
      - grafana-logs:/var/log/grafana
    environment:
      - SERVER_PORT=5109
      - SERVER_URL=${SERVER_URL:-http://localhost:5109}
      - DEBUG=${DEBUG:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      
      # External Supabase Database Configuration
      - SUPABASE_DB_URI=${SUPABASE_DB_URI}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      
      # Grafana Configuration
      - GRAFANA_ADMIN_USER=admin
      - GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin123}
      - GRAFANA_SECRET_KEY=${GRAFANA_SECRET_KEY}
      - GRAFANA_DOMAIN=${GRAFANA_DOMAIN:-localhost}
      - GF_SERVER_HTTP_PORT=3000
      - GF_SERVER_PROTOCOL=http
      - GF_SERVER_DOMAIN=${GRAFANA_DOMAIN:-localhost}
      - GF_SERVER_ROOT_URL=${SERVER_URL:-http://localhost:5109}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      
    restart: unless-stopped
    networks:
      - hetzner_network

  # Backend Host 1 - Device Controller (Location 1)
  backend_host_1:
    build:
      context: ../../../
      dockerfile: backend_host/Dockerfile
    container_name: virtualpytest-backend-host-1
    hostname: backend-host-1
    ports:
      - "6109:80"  # External port 6109 maps to internal port 80
    volumes:
      - /dev:/dev  # Hardware access for device control
      - ../../../.env:/app/.env:ro  # Shared environment variables (project root)
      - ../../../backend_host_1/.env:/app/backend_host/src/.env:ro  # Host 1 specific config
    depends_on:
      - backend_server
    privileged: true  # Required for hardware access
    restart: unless-stopped
    networks:
      - hetzner_network

  # Backend Host 2 - Device Controller (Location 2)
  backend_host_2:
    build:
      context: ../../../
      dockerfile: backend_host/Dockerfile
    container_name: virtualpytest-backend-host-2
    hostname: backend-host-2
    ports:
      - "6110:80"  # External port 6110 maps to internal port 80
    volumes:
      - /dev:/dev  # Hardware access for device control
      - ../../../.env:/app/.env:ro  # Shared environment variables (project root)
      - ../../../backend_host_2/.env:/app/backend_host/src/.env:ro  # Host 2 specific config
    depends_on:
      - backend_server
    privileged: true  # Required for hardware access
    restart: unless-stopped
    networks:
      - hetzner_network

volumes:
  # Grafana configuration and dashboards
  grafana-data:
    name: virtualpytest-hetzner-grafana-data
  grafana-logs:
    name: virtualpytest-hetzner-grafana-logs

networks:
  hetzner_network:
    name: virtualpytest-hetzner-network
    driver: bridge

