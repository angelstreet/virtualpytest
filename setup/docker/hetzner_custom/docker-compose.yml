# VirtualPyTest Hetzner Custom Deployment
# 1 Backend Server + 2 Backend Hosts
# Use: docker-compose -f setup/docker/hetzner_custom/docker-compose.yml up

services:
  # Backend Server - API + Grafana (Centralized)
  backend_server:
    build:
      context: ../../../
      dockerfile: backend_server/Dockerfile
    container_name: virtualpytest-backend-server
    ports:
      - "5109:5109"  # nginx proxy (Flask API + Grafana)
      - "3000:3000"  # Grafana direct access
    volumes:
      - grafana-data:/var/lib/grafana
      - grafana-logs:/var/log/grafana
    environment:
      - SERVER_PORT=5109
      - SERVER_URL=${SERVER_URL:-http://localhost:5109}
      - DEBUG=${DEBUG:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      
      # External Supabase Database Configuration
      - SUPABASE_DB_URI=${SUPABASE_DB_URI}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      
      # Grafana Configuration
      - GRAFANA_ADMIN_USER=admin
      - GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin123}
      - GRAFANA_SECRET_KEY=${GRAFANA_SECRET_KEY}
      - GRAFANA_DOMAIN=${GRAFANA_DOMAIN:-localhost}
      - GF_SERVER_HTTP_PORT=3000
      - GF_SERVER_PROTOCOL=http
      - GF_SERVER_DOMAIN=${GRAFANA_DOMAIN:-localhost}
      - GF_SERVER_ROOT_URL=${SERVER_URL:-http://localhost:5109}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      
      # Grafana Supabase Datasource Configuration
      - GF_DATABASE_TYPE=postgres
      - GF_DATABASE_HOST=${SUPABASE_DB_HOST}
      - GF_DATABASE_NAME=${SUPABASE_DB_NAME}
      - GF_DATABASE_USER=${SUPABASE_DB_USER}
      - GF_DATABASE_PASSWORD=${SUPABASE_DB_PASSWORD}
      
    env_file:
      - ../../../.env
    restart: unless-stopped
    networks:
      - hetzner_network

  # Backend Host 1 - Device Controller (Location 1)
  backend_host_1:
    build:
      context: ../../../
      dockerfile: backend_host/Dockerfile
    container_name: virtualpytest-backend-host-1
    hostname: backend-host-1
    ports:
      - "6109:6109"
    volumes:
      - /dev:/dev  # Hardware access for device control
    environment:
      - HOST_PORT=6109
      - HOST_NAME=${HOST1_NAME:-hetzner-host-1}
      - HOST_URL=${HOST1_URL:-http://localhost:6109}
      - SERVER_URL=http://backend_server:5109
      - DEBUG=${DEBUG:-false}
      
      # External Backend Server Connection
      - SERVER_URL=http://backend_server:5109
      
      # External Supabase Database Configuration (optional - direct DB access)
      - SUPABASE_DB_URI=${SUPABASE_DB_URI}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      
      # Device 1 Configuration
      - DEVICE1_NAME=${HOST1_DEVICE1_NAME:-Device_Host1_1}
      - DEVICE1_MODEL=${HOST1_DEVICE1_MODEL}
      - DEVICE1_VIDEO=${HOST1_DEVICE1_VIDEO:-/dev/video0}
      - DEVICE1_AUDIO=${HOST1_DEVICE1_AUDIO:-plughw:1,0}
      - DEVICE1_REMOTE=${HOST1_DEVICE1_REMOTE:-ir_blaster}
      
    env_file:
      - ../../../.env
    depends_on:
      - backend_server
    privileged: true  # Required for hardware access
    restart: unless-stopped
    networks:
      - hetzner_network

  # Backend Host 2 - Device Controller (Location 2)
  backend_host_2:
    build:
      context: ../../../
      dockerfile: backend_host/Dockerfile
    container_name: virtualpytest-backend-host-2
    hostname: backend-host-2
    ports:
      - "6110:6109"  # Different external port, same internal port
    volumes:
      - /dev:/dev  # Hardware access for device control
    environment:
      - HOST_PORT=6109
      - HOST_NAME=${HOST2_NAME:-hetzner-host-2}
      - HOST_URL=${HOST2_URL:-http://localhost:6110}
      - SERVER_URL=http://backend_server:5109
      - DEBUG=${DEBUG:-false}
      
      # External Backend Server Connection
      - SERVER_URL=http://backend_server:5109
      
      # External Supabase Database Configuration (optional - direct DB access)
      - SUPABASE_DB_URI=${SUPABASE_DB_URI}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      
      # Device 1 Configuration
      - DEVICE1_NAME=${HOST2_DEVICE1_NAME:-Device_Host2_1}
      - DEVICE1_MODEL=${HOST2_DEVICE1_MODEL}
      - DEVICE1_VIDEO=${HOST2_DEVICE1_VIDEO:-/dev/video0}
      - DEVICE1_AUDIO=${HOST2_DEVICE1_AUDIO:-plughw:1,0}
      - DEVICE1_REMOTE=${HOST2_DEVICE1_REMOTE:-ir_blaster}
      
    env_file:
      - ../../../.env
    depends_on:
      - backend_server
    privileged: true  # Required for hardware access
    restart: unless-stopped
    networks:
      - hetzner_network

volumes:
  # Grafana configuration and dashboards
  grafana-data:
    name: virtualpytest-hetzner-grafana-data
  grafana-logs:
    name: virtualpytest-hetzner-grafana-logs

networks:
  hetzner_network:
    name: virtualpytest-hetzner-network
    driver: bridge

