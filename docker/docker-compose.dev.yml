version: '3.8'

services:
  # Development version with volume mounts for hot reload
  backend-host:
    build:
      context: ../
      dockerfile: backend-host/Dockerfile
    ports:
      - "6109:6109"
    volumes:
      - ../shared:/app/shared
      - ../backend-core:/app/backend-core
      - ../backend-host:/app/backend-host
      - /dev:/dev  # Hardware access
    environment:
      - HOST_PORT=6109
      - HOST_NAME=dev-host-1
      - HOST_URL=http://localhost:6109
      - SERVER_URL=http://backend-server:5109
      - DEBUG=true
      - FLASK_ENV=development
    privileged: true
    restart: unless-stopped
    command: ["python", "src/app.py"]

  backend-server:
    build:
      context: ../
      dockerfile: backend-server/Dockerfile
    ports:
      - "5109:5109"
    volumes:
      - ../shared:/app/shared
      - ../backend-server:/app/backend-server
    environment:
      - SERVER_PORT=5109
      - SERVER_URL=http://localhost:5109
      - DEBUG=true
      - FLASK_ENV=development
      - CORS_ORIGINS=http://localhost:3000,http://localhost:5173
    restart: unless-stopped
    command: ["python", "src/app.py"]

  # Development frontend with Vite dev server
  frontend-dev:
    build:
      context: ../frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ../frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:5109
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - backend-server
    restart: unless-stopped
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]

networks:
  default:
    name: virtualpytest-dev-network 